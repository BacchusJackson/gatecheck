package blacklist

import (
	"fmt"
	"github.com/gatecheckdev/gatecheck/pkg/entity"
	"strings"
)

func BlacklistedVulnerabilities(report entity.GrypeScanReport, blacklist entity.KEVCatalog) []entity.KEVCatalogVulnerability {
	matchedVulnerabilities := make([]entity.KEVCatalogVulnerability, 0)

	for _, reportedVulnerability := range report.Matches {
		for _, blacklistCVE := range blacklist.Vulnerabilities {
			if reportedVulnerability.Vulnerability.ID == blacklistCVE.CveID {
				matchedVulnerabilities = append(matchedVulnerabilities, blacklistCVE)
			}
		}
	}

	return matchedVulnerabilities
}

func StringBlacklistedVulnerabilities(catVersion string, v []entity.KEVCatalogVulnerability) string {
	var sb strings.Builder
	sb.WriteString("Blacklisted Vulnerabilities Report\n")
	sb.WriteString(fmt.Sprintf("Catalog Version: %s\n", catVersion))

	if len(v) == 0 {
		sb.WriteString("0 Blacklisted Vulnerabilities Matched\n")
		return sb.String()
	}

	sb.WriteString(fmt.Sprintf("%-15s | %-10s | %-45s | %s\n",
		"CVE ID", "Date Added", "CVE.org Link", "Vulnerability Name"))

	divider := strings.Repeat("-", 100) + "\n"
	sb.WriteString(divider)

	for _, value := range v {
		link := fmt.Sprintf("https://www.cve.org/CVERecord?id=%s", value.CveID)
		sb.WriteString(fmt.Sprintf("%-15s | %-10s | %-45s | %s\n",
			value.CveID, value.DateAdded, link, value.VulnerabilityName))
	}
	return sb.String()
}
