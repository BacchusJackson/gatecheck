package blacklist

import (
	"github.com/anchore/grype/grype/presenter/models"
	"github.com/gatecheckdev/gatecheck/pkg/entity"
	"testing"
)

func TestBlacklistedVulnerabilities(t *testing.T) {
	r := entity.GrypeScanReport{Matches: []models.Match{
		{Vulnerability: models.Vulnerability{VulnerabilityMetadata: models.VulnerabilityMetadata{ID: "A"}}},
		{Vulnerability: models.Vulnerability{VulnerabilityMetadata: models.VulnerabilityMetadata{ID: "B"}}},
		{Vulnerability: models.Vulnerability{VulnerabilityMetadata: models.VulnerabilityMetadata{ID: "C"}}},
	}}
	br := entity.KEVCatalog{Vulnerabilities: []entity.KEVCatalogVulnerability{
		{CveID: "A"},
		{CveID: "C"},
	}}

	matchedVulnerabilities := BlacklistedVulnerabilities(r, br)

	if len(matchedVulnerabilities) != 2 {
		t.Error(matchedVulnerabilities)
		t.Fatal("Matching algo failed")
	}

	t.Log(StringBlacklistedVulnerabilities("2022.11.08", matchedVulnerabilities))

	t.Run("test-no-vulnerabilities", func(t *testing.T) {

		br := entity.KEVCatalog{Vulnerabilities: []entity.KEVCatalogVulnerability{
			{CveID: "D"},
			{CveID: "F"},
		}}

		matchedVulnerabilities := BlacklistedVulnerabilities(r, br)
		if len(matchedVulnerabilities) != 0 {
			t.Fatal("False positives found")
		}

		t.Log(StringBlacklistedVulnerabilities("2022.11.08", matchedVulnerabilities))
	})

}
